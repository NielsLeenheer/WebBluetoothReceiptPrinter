class t{constructor(t){this._events={}}on(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)}emit(t,...e){let i=this._events[t];i&&i.forEach((t=>{setTimeout((()=>t(...e)),0)}))}}class e{constructor(){this._queue=[],this._working=!1}add(t){let e=this;this._queue.push(t),this._working||async function t(){if(!e._queue.length)return void(e._working=!1);e._working=!0;let i=e._queue.shift();await i(),t()}()}}const i=[{filters:[{name:"BlueTooth Printer",services:["000018f0-0000-1000-8000-00805f9b34fb"]}],functions:{print:{service:"000018f0-0000-1000-8000-00805f9b34fb",characteristic:"00002af1-0000-1000-8000-00805f9b34fb"},status:{service:"000018f0-0000-1000-8000-00805f9b34fb",characteristic:"00002af0-0000-1000-8000-00805f9b34fb"}},language:"esc-pos",codepageMapping:"zjiang"},{filters:[{name:"Printer001",services:["000018f0-0000-1000-8000-00805f9b34fb"]}],functions:{print:{service:"000018f0-0000-1000-8000-00805f9b34fb",characteristic:"00002af1-0000-1000-8000-00805f9b34fb"},status:{service:"000018f0-0000-1000-8000-00805f9b34fb",characteristic:"00002af0-0000-1000-8000-00805f9b34fb"}},language:"esc-pos",codepageMapping:"xprinter"},{filters:[{services:["000018f0-0000-1000-8000-00805f9b34fb"]}],functions:{print:{service:"000018f0-0000-1000-8000-00805f9b34fb",characteristic:"00002af1-0000-1000-8000-00805f9b34fb"},status:{service:"000018f0-0000-1000-8000-00805f9b34fb",characteristic:"00002af0-0000-1000-8000-00805f9b34fb"}},language:"esc-pos",codepageMapping:"default"}];class s{}class a extends s{#t;#e;#i=null;#s=null;#a={print:null,status:null};constructor(){super(),this.#t=new t,this.#e=new e,navigator.bluetooth.addEventListener("disconnect",(t=>{this.#i==t.device&&this.#t.emit("disconnected")}))}async connect(){try{let t=await navigator.bluetooth.requestDevice({filters:i.map((t=>t.filters)).reduce(((t,e)=>t.concat(e)))});t&&await this.#c(t)}catch(t){console.log("Could not connect! "+t)}}async reconnect(t){if(!navigator.bluetooth.getDevices)return;let e=(await navigator.bluetooth.getDevices()).find((e=>e.id==t.id));e&&await this.#c(e)}async#c(t){this.#i=t;let e=await this.#i.gatt.connect(),s=(await e.getPrimaryServices()).map((t=>t.uuid));this.#s=i.find((t=>t.filters.some((t=>this.#r(t,s)))));let a=await e.getPrimaryService(this.#s.functions.print.service);if(this.#a.print=await a.getCharacteristic(this.#s.functions.print.characteristic),this.#s.functions.status){let t=await e.getPrimaryService(this.#s.functions.status.service);this.#a.status=await t.getCharacteristic(this.#s.functions.status.characteristic)}this.#t.emit("connected",{type:"bluetooth",name:this.#i.name,id:this.#i.id,language:await this.#n(this.#s.language),codepageMapping:await this.#n(this.#s.codepageMapping)})}async#n(t){return"function"==typeof t?await t(this.#i):t}#r(t,e){if(t.services)for(let i of t.services)if(!e.includes(i))return!1;return(!t.name||this.#i.name==t.name)&&!(t.namePrefix&&!this.#i.name.startsWith(t.namePrefix))}async listen(){return!!this.#a.status&&(await this.#a.status.startNotifications(),this.#a.status.addEventListener("characteristicvaluechanged",(t=>{this.#t.emit("data",t.target.value)})),!0)}async disconnect(){this.#i&&(await this.#i.gatt.disconnect(),this.#i=null,this.#a.print=null,this.#a.status=null,this.#s=null,this.#t.emit("disconnected"))}print(t){return new Promise((e=>{let i=Math.ceil(t.length/100);if(1===i){let e=t;this.#e.add((()=>this.#a.print.writeValueWithResponse(e)))}else for(let e=0;e<i;e++){let i=100*e,s=Math.min(t.length,i+100),a=t.slice(i,s);this.#e.add((()=>this.#a.print.writeValueWithResponse(a)))}this.#e.add((()=>e()))}))}addEventListener(t,e){this.#t.on(t,e)}}export{a as default};
//# sourceMappingURL=webbluetooth-receipt-printer.esm.js.map
